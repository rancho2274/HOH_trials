
{% extends "base.html" %}
{% block content %}
<div class="header">
  <h2>Live API Health: Payment</h2>
  <!-- <button class="refresh-btn" onclick="refreshDashboard()">
    <i class="fas fa-sync-alt"></i> Refresh
  </button> -->
</div>

<div class="cards">
  <div class="card">
    <h4>Total Logs</h4>
    <h3 id="total-logs">0</h3>
    <small id="total-logs-note" class="green">+0 this month</small>
  </div>
  <div class="card">
    <h4>Active Issues</h4>
    <h3 id="active-issues">0</h3>
    <small id="active-issues-note" class="red">+0 from yesterday</small>
  </div>
  <div class="card">
    <h4>Average Response</h4>
    <h3 id="avg-response">0ms</h3>
    <small id="avg-response-note" class="green">0ms improvement</small>
  </div>
  <div class="card">
    <h4>System Health</h4>
    <h3 id="system-health">100%</h3>
    <small id="system-health-note" class="green">+0% this week</small>
  </div>
</div>

<!-- Response time cards -->
<div class="response-time-container" style="display: flex; gap: 20px; margin-top: 30px;">
  <div class="card" style="flex: 1;">
    <h4 style="color: #0072CE;">Normal Response Time</h4>
    <h3 id="normal-response" style="font-size: 28px; color: #003366;">0 ms</h3>
    <small style="color: #28a745;">Average for normal operations</small>
  </div>
  
  <div class="card" style="flex: 1;">
    <h4 style="color: #0072CE;">Anomalous Response Time</h4>
    <h3 id="anomalous-response" style="font-size: 28px; color: #003366;">0 ms</h3>
    <small style="color: #dc3545;">Average for anomalous operations</small>
  </div>
</div>

<!-- Kibana Dashboard Section -->
<div class="kibana-container">
  <h3 style="margin-top: 30px; margin-bottom: 15px; color: #0072CE;">Live Kibana Dashboard</h3>
  <div class="kibana-frame">
    <div class="kibana-loading">
      <i class="fas fa-spinner"></i> Loading Kibana Dashboard...
    </div>
    <iframe src="http://localhost:5601/app/dashboards#/view/payment-api-dashboard" height="600" width="100%" frameborder="0" style="display: none;"></iframe>
  </div>
</div>

<script>
  function refreshDashboard() {
    fetch('/refresh')
      .then(res => res.json())
      .then(data => {
        // Get payment API specific stats
        const paymentStats = data.api_stats.payment;
        
        // Update the dashboard metrics
        document.getElementById('total-logs').textContent = paymentStats.total_logs || 0;
        document.getElementById('active-issues').textContent = paymentStats.anomalies || 0;
        document.getElementById('avg-response').textContent = (paymentStats.normal_avg || 0) + 'ms';
        document.getElementById('system-health').textContent = paymentStats.anomaly_percent 
          ? (100 - paymentStats.anomaly_percent) + '%' 
          : '100%';
          
        // Update response time cards
        document.getElementById('normal-response').textContent = (paymentStats.normal_avg || 0) + ' ms';
        document.getElementById('anomalous-response').textContent = (paymentStats.anomalous_avg || 0) + ' ms';
      })
      .catch(err => {
        console.error("Error refreshing dashboard:", err);
      });
  }

  // Initial refresh on page load
  document.addEventListener('DOMContentLoaded', refreshDashboard);
</script>
{% endblock %}
```