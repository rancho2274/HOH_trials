{% extends "base.html" %}
{% block content %}
<div class="header">
  <h2>Dashboard</h2>
  <button class="refresh-btn" id="refresh-button" onclick="refreshDashboard()">
    <i class="fas fa-sync-alt"></i> Refresh
  </button>
</div>

<div class="cards">
  <div class="card">
    <h4>Total Logs</h4>
    <h3 id="total-logs">{{ stats.total_logs }}</h3>
    <small id="total-logs-note" class="green">Last updated: {{ stats.updated_timestamp }}</small>
  </div>
  <div class="card">
    <h4>Anomalies</h4>
    <h3 id="anomalies">{{ stats.anomalies }} ({{ stats.anomaly_percent }}%)</h3>
    <small id="anomalies-note" class="red">Detected response time issues</small>
  </div>
  <div class="card">
    <h4>Normal Response Time</h4>
    <h3 id="avg-response">{{ stats.normal_avg }} ms</h3>
    <small id="avg-response-note" class="green">Average for normal operations</small>
  </div>
  <div class="card">
    <h4>Anomalous Response Time</h4>
    <h3 id="anomalous-response">{{ stats.anomalous_avg }} ms</h3>
    <small id="anomalous-response-note" class="red">Average for anomalous operations</small>
  </div>
</div>

<div class="statuses">
  <div class="status">
    <h4>API Status</h4>
    <div class="status-item">
      <span>Authentication API</span>
      <span id="auth-status" class="{% if api_stats.auth.anomaly_percent > 20 %}status-red{% elif api_stats.auth.anomaly_percent > 10 %}status-yellow{% else %}status-green{% endif %}">
        {{ api_stats.auth.total_logs }} logs, {{ api_stats.auth.anomaly_percent }}% anomalous
      </span>
    </div>
    <div class="status-item">
      <span>Search API</span>
      <span id="search-status" class="{% if api_stats.search.anomaly_percent > 20 %}status-red{% elif api_stats.search.anomaly_percent > 10 %}status-yellow{% else %}status-green{% endif %}">
        {{ api_stats.search.total_logs }} logs, {{ api_stats.search.anomaly_percent }}% anomalous
      </span>
    </div>
    <div class="status-item">
      <span>Booking API</span>
      <span id="booking-status" class="{% if api_stats.booking.anomaly_percent > 20 %}status-red{% elif api_stats.booking.anomaly_percent > 10 %}status-yellow{% else %}status-green{% endif %}">
        {{ api_stats.booking.total_logs }} logs, {{ api_stats.booking.anomaly_percent }}% anomalous
      </span>
    </div>
    <div class="status-item">
      <span>Payment API</span>
      <span id="payment-status" class="{% if api_stats.payment.anomaly_percent > 20 %}status-red{% elif api_stats.payment.anomaly_percent > 10 %}status-yellow{% else %}status-green{% endif %}">
        {{ api_stats.payment.total_logs }} logs, {{ api_stats.payment.anomaly_percent }}% anomalous
      </span>
    </div>
    <div class="status-item">
      <span>Feedback API</span>
      <span id="feedback-status" class="{% if api_stats.feedback.anomaly_percent > 20 %}status-red{% elif api_stats.feedback.anomaly_percent > 10 %}status-yellow{% else %}status-green{% endif %}">
        {{ api_stats.feedback.total_logs }} logs, {{ api_stats.feedback.anomaly_percent }}% anomalous
      </span>
    </div>
  </div>
  <div class="alert">
    <h4>Response Time Information</h4>
    <div class="alert-item">
      <div>
        <div class="severity-high">High Severity</div>
        <p id="alert-1">
          {% if stats.anomalies > 0 %}
          {{ stats.anomalies }} response time anomalies detected across {{ stats.total_logs }} logs
          {% else %}
          No response time anomalies detected
          {% endif %}
        </p>
        <small id="alert-1-time">{{ stats.updated_timestamp }}</small>
      </div>
    </div>
    <div class="alert-item">
      <div>
        <div class="severity-medium">Insights</div>
        <p id="alert-2">
          {% if stats.anomalous_avg > 0 and stats.normal_avg > 0 %}
          Anomalous responses are {{ (stats.anomalous_avg / stats.normal_avg)|round(1) }}x slower than normal responses
          {% else %}
          Insufficient data to compare normal and anomalous response times
          {% endif %}
        </p>
        <small id="alert-2-time">{{ stats.updated_timestamp }}</small>
      </div>
    </div>
  </div>
</div>

<div class="loading-indicator" id="loading-indicator" style="display: none; text-align: center; margin-top: 20px;">
  <p>Processing logs and detecting anomalies... please wait.</p>
  <div class="spinner" style="margin: 10px auto; width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid #0072CE; border-radius: 50%; animation: spin 1s linear infinite;"></div>
</div>

<div class="api-summary">
  <h3>API Anomaly Analysis Summary</h3>
  <p>The dashboard has analyzed log files from all APIs and detected response time anomalies based on statistical analysis. 
  Below is a summary of the findings:</p>
  
  <table class="api-table">
    <thead>
      <tr>
        <th>API</th>
        <th>Total Logs</th>
        <th>Anomalies</th>
        <th>Anomaly %</th>
        <th>Normal Avg (ms)</th>
        <th>Anomalous Avg (ms)</th>
        <th>Ratio</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>Authentication</td>
        <td>{{ api_stats.auth.total_logs }}</td>
        <td>{{ api_stats.auth.anomalies }}</td>
        <td>{{ api_stats.auth.anomaly_percent }}%</td>
        <td>{{ api_stats.auth.normal_avg }}</td>
        <td>{{ api_stats.auth.anomalous_avg }}</td>
        <td>{% if api_stats.auth.normal_avg > 0 and api_stats.auth.anomalous_avg > 0 %}{{ (api_stats.auth.anomalous_avg / api_stats.auth.normal_avg)|round(1) }}x{% else %}-{% endif %}</td>
      </tr>
      <tr>
        <td>Search</td>
        <td>{{ api_stats.search.total_logs }}</td>
        <td>{{ api_stats.search.anomalies }}</td>
        <td>{{ api_stats.search.anomaly_percent }}%</td>
        <td>{{ api_stats.search.normal_avg }}</td>
        <td>{{ api_stats.search.anomalous_avg }}</td>
        <td>{% if api_stats.search.normal_avg > 0 and api_stats.search.anomalous_avg > 0 %}{{ (api_stats.search.anomalous_avg / api_stats.search.normal_avg)|round(1) }}x{% else %}-{% endif %}</td>
      </tr>
      <tr>
        <td>Booking</td>
        <td>{{ api_stats.booking.total_logs }}</td>
        <td>{{ api_stats.booking.anomalies }}</td>
        <td>{{ api_stats.booking.anomaly_percent }}%</td>
        <td>{{ api_stats.booking.normal_avg }}</td>
        <td>{{ api_stats.booking.anomalous_avg }}</td>
        <td>{% if api_stats.booking.normal_avg > 0 and api_stats.booking.anomalous_avg > 0 %}{{ (api_stats.booking.anomalous_avg / api_stats.booking.normal_avg)|round(1) }}x{% else %}-{% endif %}</td>
      </tr>
      <tr>
        <td>Payment</td>
        <td>{{ api_stats.payment.total_logs }}</td>
        <td>{{ api_stats.payment.anomalies }}</td>
        <td>{{ api_stats.payment.anomaly_percent }}%</td>
        <td>{{ api_stats.payment.normal_avg }}</td>
        <td>{{ api_stats.payment.anomalous_avg }}</td>
        <td>{% if api_stats.payment.normal_avg > 0 and api_stats.payment.anomalous_avg > 0 %}{{ (api_stats.payment.anomalous_avg / api_stats.payment.normal_avg)|round(1) }}x{% else %}-{% endif %}</td>
      </tr>
      <tr>
        <td>Feedback</td>
        <td>{{ api_stats.feedback.total_logs }}</td>
        <td>{{ api_stats.feedback.anomalies }}</td>
        <td>{{ api_stats.feedback.anomaly_percent }}%</td>
        <td>{{ api_stats.feedback.normal_avg }}</td>
        <td>{{ api_stats.feedback.anomalous_avg }}</td>
        <td>{% if api_stats.feedback.normal_avg > 0 and api_stats.feedback.anomalous_avg > 0 %}{{ (api_stats.feedback.anomalous_avg / api_stats.feedback.normal_avg)|round(1) }}x{% else %}-{% endif %}</td>
      </tr>
    </tbody>
  </table>
  
  <div class="note-box">
    <p><strong>Note:</strong> All logs with detected anomalies have been marked with a <code>response_anomaly</code> flag in the combine_logs directory.
    You can click on any API in the sidebar menu to see more detailed information about that specific API.</p>
  </div>
</div>

<style>
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.api-summary {
  margin-top: 30px;
  background: #f9fafe;
  padding: 20px;
  border-radius: 10px;
  border: 1px solid #e2e8f0;
}

.api-summary h3 {
  color: #0072CE;
  margin-top: 0;
}

.api-table {
  width: 100%;
  border-collapse: collapse;
  margin: 20px 0;
}

.api-table th, .api-table td {
  border: 1px solid #e2e8f0;
  padding: 10px;
  text-align: center;
}

.api-table th {
  background-color: #f1f5f9;
  font-weight: bold;
}

.api-table tr:nth-child(even) {
  background-color: #f8fafc;
}

.note-box {
  background: #f0f7ff;
  padding: 15px;
  border-left: 4px solid #0072CE;
  margin-top: 20px;
  border-radius: 4px;
}

code {
  background: #f1f5f9;
  padding: 2px 4px;
  border-radius: 4px;
  font-family: monospace;
}
</style>

<script>
  function refreshDashboard() {
    // Show loading indicator
    document.getElementById('loading-indicator').style.display = 'block';
    document.getElementById('refresh-button').disabled = true;
    
    // Use window.location instead of fetch to avoid AJAX errors
    window.location.href = '/refresh';
  }
  
  function updateApiStatus(apiName, apiStats) {
    const statusElement = document.getElementById(apiName + '-status');
    
    // Update text
    statusElement.textContent = apiStats.total_logs + ' logs, ' + apiStats.anomaly_percent + '% anomalous';
    
    // Update status color
    if (apiStats.anomaly_percent > 20) {
      statusElement.className = 'status-red';
    } else if (apiStats.anomaly_percent > 10) {
      statusElement.className = 'status-yellow';
    } else {
      statusElement.className = 'status-green';
    }
  }
</script>
{% endblock %}