{% extends "base.html" %}
{% block content %}
<div class="header">
  <h2>Dashboard</h2>
  <button class="refresh-btn" onclick="refreshDashboard()">
    <i class="fas fa-sync-alt"></i> Refresh
  </button>
</div>

<!-- Response Time Spike Alerts Section - MODIFIED FOR COMPACTNESS -->
<div id="alerts-container" class="{% if has_alerts %}active{% endif %}" style="margin-bottom: 20px;">
  <div class="alerts-wrapper">
    <div class="alerts-header">
      <h3><i class="fas fa-exclamation-triangle"></i> Response Time Spike Alerts</h3>
      <button id="close-alerts" class="close-btn"><i class="fas fa-times"></i></button>
    </div>
    <div class="alerts-content">
      <div id="alerts-list">
        {% if alerts %}
          {% for alert in alerts[:5] %}
            <div class="alert-item alert-{{ alert.severity|lower }}">
              <div class="alert-icon">
                {% if alert.severity == 'CRITICAL' %}
                  <i class="fas fa-exclamation-circle"></i>
                {% elif alert.severity == 'HIGH' %}
                  <i class="fas fa-exclamation-triangle"></i>
                {% else %}
                  <i class="fas fa-info-circle"></i>
                {% endif %}
              </div>
              <div class="alert-content">
                <div class="alert-title">{{ alert.message }}</div>
                <div class="alert-meta">
                  <span><i class="fas fa-clock"></i> {{ alert.timestamp }}</span>
                  <span><i class="fas fa-server"></i> {{ alert.api }}</span>
                </div>
              </div>
            </div>
          {% endfor %}
          
          {% if alerts|length > 5 %}
            <div class="alert-more">
              <button id="show-all-alerts" class="show-more-btn" onclick="location.href='{{ url_for('alerts') }}'">
                Show {{ alerts|length - 5 }} more alerts...
              </button>
            </div>
          {% endif %}
        {% else %}
          <div class="alert-empty">
            No alerts at this time
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<div class="cards">
  <div class="card">
    <h4>Total APIs</h4>
    <h3 id="total-apis">5</h3>
    <small id="total-apis-note" class="green">+0 this month</small>
  </div>
  <div class="card">
    <h4>Active Issues</h4>
    <h3 id="active-issues">{{ alerts|length if alerts else 0 }}</h3>
    <small id="active-issues-note" class="red">+{{ alerts|length if alerts else 0 }} from yesterday</small>
  </div>
  <div class="card">
    <h4>Average Response</h4>
    <h3 id="avg-response">{{ stats.normal_avg|round|int if stats.normal_avg else 0 }}ms</h3>
    <small id="avg-response-note" class="green">{{ stats.normal_avg|round|int if stats.normal_avg else 0 }}ms typical</small>
  </div>
  <div class="card">
    <h4>System Health</h4>
    <h3 id="system-health">{{ (100 - alerts|length * 10)|round|int if alerts else 100 }}%</h3>
    <small id="system-health-note" class="{% if alerts %}red{% else %}green{% endif %}">{% if alerts %}-{{ alerts|length * 10 }}% this hour{% else %}No issues{% endif %}</small>
  </div>
</div>

<div class="statuses">
  <div class="status">
    <h4>Real-time API Status</h4>
    {% for api_name, api_data in api_stats.items() %}
      <div class="status-item">
        <span>{{ api_name|capitalize }} API</span>
        <span class="status-{% if api_name in api_spikes and api_spikes[api_name]|length > 0 %}red{% else %}green{% endif %}">
          {{ api_data.normal_avg|round|int if api_data.normal_avg else 0 }}ms
        </span>
      </div>
    {% endfor %}
  </div>
  <div class="alert">
    <h4>Critical Alerts</h4>
    {% if alerts %}
      {% for alert in alerts[:2] %}
        <div class="alert-item">
          <div>
            <div class="severity-{% if alert.severity == 'CRITICAL' %}high{% else %}medium{% endif %}">
              {{ alert.severity }} Alert
            </div>
            <p>{{ alert.message }}</p>
            <small>{{ alert.timestamp }}</small>
          </div>
        </div>
      {% endfor %}
    {% else %}
      <div class="alert-item">
        <div>
          <p>No critical alerts at this time</p>
          <small>System is running normally</small>
        </div>
      </div>
    {% endif %}
  </div>
</div>

<style>
  /* Alerts Container - MODIFIED FOR COMPACTNESS */
  #alerts-container {
    display: none;
    margin-bottom: 20px;
    animation: slideDown 0.3s ease-out;
  }
  
  #alerts-container.active {
    display: block;
  }
  
  .alerts-wrapper {
    background-color: #ffffff;
    border-radius: 8px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    overflow: hidden;
  }
  
  .alerts-header {
    background-color: #00395D;
    color: white;
    padding: 12px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .alerts-header h3 {
    margin: 0;
    font-size: 16px;
    display: flex;
    align-items: center;
  }
  
  .alerts-header h3 i {
    margin-right: 8px;
  }
  
  .close-btn {
    background: none;
    border: none;
    color: white;
    font-size: 18px;
    cursor: pointer;
  }
  
  .alerts-content {
    max-height: 300px;
    overflow-y: auto;
  }
  
  /* Alert Items - MODIFIED FOR COMPACTNESS */
  .alert-item {
    display: flex;
    padding: 10px 15px;
    border-bottom: 1px solid #edf2f7;
  }
  
  .alert-icon {
    margin-right: 12px;
    font-size: 18px;
    padding-top: 2px;
  }
  
  .alert-content {
    flex: 1;
  }
  
  .alert-title {
    font-weight: bold;
    margin-bottom: 4px;
  }
  
  .alert-meta {
    display: flex;
    gap: 15px;
    font-size: 12px;
    color: #64748b;
  }
  
  /* Severity Styles */
  .alert-critical {
    border-left: 4px solid #e53e3e;
    background-color: rgba(229, 62, 62, 0.05);
  }
  
  .alert-critical .alert-icon {
    color: #e53e3e;
  }
  
  .alert-high {
    border-left: 4px solid #ed8936;
    background-color: rgba(237, 137, 54, 0.05);
  }
  
  .alert-high .alert-icon {
    color: #ed8936;
  }
  
  .alert-medium {
    border-left: 4px solid #4299e1;
    background-color: rgba(66, 153, 225, 0.05);
  }
  
  .alert-medium .alert-icon {
    color: #4299e1;
  }
  
  /* Empty State */
  .alert-empty {
    padding: 20px;
    text-align: center;
    color: #64748b;
  }
  
  /* Show More Button */
  .alert-more {
    padding: 10px;
    text-align: center;
  }
  
  .show-more-btn {
    background-color: #f1f5f9;
    border: none;
    border-radius: 4px;
    padding: 8px 12px;
    font-size: 14px;
    cursor: pointer;
  }
  
  .show-more-btn:hover {
    background-color: #e2e8f0;
  }
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.1/chart.min.js"></script>
<script>
  // Initialize alert check interval
  let alertCheckInterval;
  
  // Setup alert controls
  document.addEventListener('DOMContentLoaded', function() {
    // Close alerts button
    document.getElementById('close-alerts').addEventListener('click', function() {
      document.getElementById('alerts-container').classList.remove('active');
    });
    
    // Start periodic spike check
    startSpikeCheck();
  });
  
  function startSpikeCheck() {
    // Check for spikes every 30 seconds
    alertCheckInterval = setInterval(checkForSpikes, 30000);
    
    // Do an initial check
    checkForSpikes();
  }
  
  function checkForSpikes() {
    fetch('/api/check_spikes')
      .then(response => response.json())
      .then(data => {
        if (data.has_alerts) {
          // Show alerts container
          const alertsContainer = document.getElementById('alerts-container');
          alertsContainer.classList.add('active');
          
          // Add pulse effect if there are critical alerts
          const criticalAlerts = data.alerts.filter(a => a.severity === 'CRITICAL');
          if (criticalAlerts.length > 0) {
            alertsContainer.classList.add('pulse');
          } else {
            alertsContainer.classList.remove('pulse');
          }
          
          // Update alerts list
          updateAlertsList(data.alerts);
          
          // Update dashboard stats
          document.getElementById('active-issues').textContent = data.alerts.length;
          document.getElementById('active-issues-note').textContent = `+${data.alerts.length} from yesterday`;
          document.getElementById('system-health').textContent = `${(100 - data.alerts.length * 10)}%`;
          document.getElementById('system-health-note').textContent = `-${data.alerts.length * 10}% this hour`;
          document.getElementById('system-health-note').className = 'red';
        }
      })
      .catch(error => console.error('Error checking for spikes:', error));
  }
  
  function updateAlertsList(alerts) {
    const alertsList = document.getElementById('alerts-list');
    if (!alertsList) return;
    
    // Only show the first 5 alerts in the panel
    const displayAlerts = alerts.slice(0, 5);
    
    // Clear current alerts
    alertsList.innerHTML = '';
    
    if (displayAlerts.length === 0) {
      alertsList.innerHTML = '<div class="alert-empty">No alerts at this time</div>';
      return;
    }
    
    // Add each alert
    displayAlerts.forEach(alert => {
      const alertItem = document.createElement('div');
      alertItem.className = `alert-item alert-${alert.severity.toLowerCase()}`;
      
      let iconClass = 'info-circle';
      if (alert.severity === 'CRITICAL') iconClass = 'exclamation-circle';
      else if (alert.severity === 'HIGH') iconClass = 'exclamation-triangle';
      
      alertItem.innerHTML = `
        <div class="alert-icon">
          <i class="fas fa-${iconClass}"></i>
        </div>
        <div class="alert-content">
          <div class="alert-title">${alert.message}</div>
          <div class="alert-meta">
            <span><i class="fas fa-clock"></i> ${alert.timestamp}</span>
            <span><i class="fas fa-server"></i> ${alert.api}</span>
          </div>
        </div>
      `;
      
      alertsList.appendChild(alertItem);
    });
    
    // Add "Show more" button if needed
    if (alerts.length > 5) {
      const moreButton = document.createElement('div');
      moreButton.className = 'alert-more';
      moreButton.innerHTML = `
        <button id="show-all-alerts" class="show-more-btn" onclick="location.href='/alerts'">
          Show ${alerts.length - 5} more alerts...
        </button>
      `;
      alertsList.appendChild(moreButton);
    }
  }
  
  function refreshDashboard() {
    location.reload();
  }
</script>
{% endblock %}